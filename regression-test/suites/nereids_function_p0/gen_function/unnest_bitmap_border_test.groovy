// Licensed to the Apache Software Foundation (ASF) under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The ASF licenses this file
// to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.  You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing,
// software distributed under the License is distributed on an
// "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
// KIND, either express or implied.  See the License for the
// specific language governing permissions and limitations
// under the License.

suite("unnest_bitmap_border_test", "unnest") {

    // normal array
    // Test unnesting a bitmap created from a string.
    qt_unnest_bitmap_from_string """SELECT 
            group_name,
            user_id
        FROM (
            SELECT 
                'Active_Users' AS group_name, 
                bitmap_from_string('10,20,30') AS bm
        ) t,
        UNNEST(bm) AS v(user_id)
        ORDER BY group_name, user_id;"""

    // Test unnesting an empty bitmap.
    qt_unnest_empty_bitmap """SELECT 'empty_test' as c, id FROM (SELECT bitmap_empty() AS bm) t, UNNEST(bm) AS v(id) ORDER BY c, id;"""

    // Test unnesting a bitmap created from a string containing a null value.
    qt_unnest_bitmap_with_null_string """SELECT 'empty_test' as c, id FROM (SELECT bitmap_from_string('1,null,3') AS bm) t, UNNEST(bm) AS v(id) ORDER BY c, id;"""

    // Test unnesting bitmaps from rows generated by a UNION ALL clause.
    qt_unnest_bitmap_with_union """SELECT 
            tag,
            val
        FROM (
            SELECT 'Tag_A' as tag, to_bitmap(1) as bm
            UNION ALL
            SELECT 'Tag_B' as tag, to_bitmap(2) as bm
        ) t, UNNEST(bm) AS v(val)
        ORDER BY tag, val;
        """


    // Test unnesting bitmaps created from an integer and a NULL value.
    qt_unnest_bitmap_from_int_and_null """SELECT 
            case_name,
            val
        FROM (
            SELECT 'Single_Int' as case_name, to_bitmap(100) as bm
            UNION ALL
            SELECT 'Null_Input' as case_name, to_bitmap(NULL) as bm 
        ) t, UNNEST(bm) AS v(val)
        ORDER BY case_name, val;
        """

    // Test unnesting bitmaps from a valid string and a string with an invalid (null) value.
    qt_unnest_bitmap_from_valid_and_invalid_string """SELECT 
            case_name,
            val
        FROM (
            SELECT 'Normal_String' as case_name, bitmap_from_string('1,3,5') as bm
            UNION ALL
            SELECT 'Invalid_String' as case_name, bitmap_from_string('1,null,3') as bm 
        ) t, UNNEST(bm) AS v(val)
        ORDER BY case_name, val;"""

    // Test unnesting a bitmap created from an integer array.
    qt_unnest_bitmap_from_array """SELECT 
            arr_type,
            val
        FROM (
            SELECT 'Integer_Array' as arr_type, bitmap_from_array(ARRAY(10, 20, 30)) as bm
        ) t, UNNEST(bm) AS v(val)
        ORDER BY arr_type, val;
        """

    // Test unnesting a bitmap created from a bitmap_union aggregation.
    qt_unnest_bitmap_after_union_aggregation """SELECT 
                val
            FROM (
                SELECT bitmap_union(to_bitmap(id)) as combined_bm 
                FROM (SELECT 1 as id UNION SELECT 2 UNION SELECT 3) temp
            ) t, UNNEST(combined_bm) AS v(val)
            ORDER BY val;
            """

    // Test generating a sequence, converting it to a bitmap, and then back to a string.
    qt_sequence_to_bitmap_string """SELECT bitmap_to_string(to_bitmap(val)) as s FROM (SELECT UNNEST(sequence(1, 10)) AS val) t ORDER BY s;"""

    // Test unnesting a bitmap containing boundary integer values.
    qt_unnest_bitmap_with_boundary_values """SELECT
            case_desc,
            val
        FROM
            (
                SELECT
                    'Boundary_Values' AS case_desc,
                    bitmap_from_string('0,2147483647,9223372036854775807') AS bm
            ) t,
            UNNEST(bm) AS v(val)
            ORDER BY case_desc, val;
        """

}
