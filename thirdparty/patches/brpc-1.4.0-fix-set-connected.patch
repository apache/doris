From 46cc6a53e4389f76420e50aedad08d2889cce42a Mon Sep 17 00:00:00 2001
From: Kaijie Chen <ckj@apache.org>
Date: Sun, 28 Jan 2024 15:58:31 +0800
Subject: [PATCH] fix set connected

---
 src/brpc/policy/baidu_rpc_protocol.cpp | 11 +++++------
 1 file changed, 5 insertions(+), 6 deletions(-)

diff --git a/src/brpc/policy/baidu_rpc_protocol.cpp b/src/brpc/policy/baidu_rpc_protocol.cpp
index 499be8db..2e1d0ecf 100644
--- a/src/brpc/policy/baidu_rpc_protocol.cpp
+++ b/src/brpc/policy/baidu_rpc_protocol.cpp
@@ -240,6 +240,11 @@ void SendRpcResponse(int64_t correlation_id,
     // stream for some reasons.
     if(cntl->has_remote_stream()){
         LOG(INFO) << "cntl has remote stream, stream_id=" << response_stream_id << " socket=" << sock->description().c_str();
+        if(stream_ptr) {
+            // Now it's ok the mark this server-side stream as connectted as all the
+            // written user data would follower the RPC response.
+            ((Stream*)stream_ptr->conn())->SetConnected();
+        }
         // Send the response over stream to notify that this stream connection
         // is successfully built.
         // Response_stream can be INVALID_STREAM_ID when error occurs.
@@ -255,12 +260,6 @@ void SendRpcResponse(int64_t correlation_id,
             }
             return;
         }
-
-        if(stream_ptr) {
-            // Now it's ok the mark this server-side stream as connectted as all the
-            // written user data would follower the RPC response.
-            ((Stream*)stream_ptr->conn())->SetConnected();
-        }
     } else{
         // Have the risk of unlimited pending responses, in which case, tell
         // users to set max_concurrency.
-- 
2.39.3

